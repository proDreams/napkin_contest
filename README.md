# Бот для Telegram-канала "[Код на салфетке](https://t.me/press_any_button)" и чата "[Кот на салфетке](https://t.me/pressanybutton_chat)"

## О репозитории
Репозиторий с исходным кодом бота для конкурса начинающих программистов на Python

## Задача
У нас есть "Бот на салфетке" - бот для канала и чата. В связи с большим количеством спамеров, приходящих в чат и
спамящих своим "очень интересным предложением", возникла необходимость в защите - введением проверки новых пользователей
чата через "капчу", при правильном ответе на которую пользователь может продолжить общаться, в противном случае бот
исключает его из чата.

Способов решения задачи несколько, от чего она является идеальной для конкурса.

### Необходимо:
1. Реализовать "капчу" для нового участника чата.
2. "Капча" должна быть в виде изображения.
3. Для упрощения, достаточно реализовать задачу на сложение, результат которой будет проверять бот.
4. Дать пользователю три попытки на решение задачи.
5. Если пользователь три раза вводит неверный ответ - исключение из чата.
6. Все сообщения пользователя без верного ответа - удалять.
7. (Опционально) Добавить таймер в течении которого пользователь должен ответить верно (включая неверные ответы), если
   не было верного ответа или не было сообщений вовсе - исключение.

## Что было сделано?
### Проведена работа по добавлению капчи в чат канала:
* Для генерации капчи использовалась библиотка PILLOW. (Случайный рабор латинских букв и цифр записанный на белый фон)
* В обработчик вступления пользователя в чат добавлена функция генерации капчи и запуск таймера - 60 секунд, если пользоваетль в течении 60 ти секунд не отвечает бот заносит его в черный список и удаляет из чата
* Для обработки правильных и не правильных ответов используется FSM Context, который инициализирует пустой словарь в event хэндленре и заносит туда необходимые для обработки в следующем хэндлере (captcha_response) данные - это ID чата и ID пользователя, имя пользователя (firstanme) , текс записанный на капче и количество попыток ответа (3)
* В хэндлере обрабоки ответов на капчу данные из event хэндлера были по ключу через FSM Context для работы с сообщениями пользователя. На то чтобы ответить верно пользователю дается 3 попытки, ответ пользователя приведенный к верхнему регистру сравнивается с текстом капчи - если пользователь ответил верно - ему поступает сообщение о том что он справился с прохождением капчи и приветсвенное  сообщение для вступивших  в чат. В случае неверного ответа количество попыток уменьшвтеся на одну и данные FSM контекста обновляются. Когда попытки закончатся бот так же заносит пользователя в черный список и удаляет из чата
### Что хотелось бы улучшить
* В хэндлере обработки ответа пользователя пришлось использоваеть обработку исключения через Try except, тк если сообщение не поступило бот реагирует на него как на объект NoneType и появляется ошибка AtributeError тк у объекта NoneType нельзя вызвать метод upper(), на функционал бота ошибка не влияет, но в терминале выгладит не красиво. Согласна с тем что обработка через  Try except не самое лучшее решение, но тк я мало знакома с работой aiogram3 на данный момент это все что я смогла пердпринять
* Если бы было больше времени на реализацию задачи можно бы было добавить удаление файла с капчей после того как пользоваель на нее ответит или будет удален из чата


## Как участвовать?
1. Необходимо сделать fork (именно fork, а не clone!) проекта. 
2. Написать функционал антиспама в отдельной ветке.
3. Убедиться, что всё работает.
4. Сделать push в свой репозиторий и из него pull request в наш.
5. Ждать начала голосования и участвовать в обсуждении своего и решений других участников.

## Используемые библиотеки
- aiogram 3
- pydantic-settings
- requests
- pillow

## Запуск
1. Создать и активировать виртуальное окружение:
   ```bash
   python -m venv .venv

   # для Windows
   venv\Scripts\activate.ps1
   # или 
   venv\Scripts\activate.bat

   # для *NIX-систем
   source venv/bin/activate
   ```
2. Установить зависимости:
   ```bash
   pip install -r requirements.txt
   ```
3. Переименовать `.env.example` в `.env` и вписать соответствующие данные:
   ```
   TOKEN=ваш_токен_бота
   ADMIN_ID=id_администратора
   GROUP_ID=id_группы
   WEATHER_KEY=токен_погоды  # не обязателен для конкурса
   AUDIO_KEY_ID=id_распознавания_голоса  # не обязателен для конкурса
   AUDIO_KEY_SECRET=токен_распознавания_голоса  # не обязателен для конкурса
   ```
4. Запустить бота:
   ```bash
   python main.py
   ```
   
## Автор
Иван Ашихмин  
Telegram-канал "[Код на салфетке](https://t.me/press_any_button)"