# Бот для Telegram-канала "[Код на салфетке](https://t.me/press_any_button)" и чата "[Кот на салфетке](https://t.me/pressanybutton_chat)"

## О репозитории
Репозиторий с исходным кодом бота для конкурса начинающих программистов на Python

## Задача
У нас есть "Бот на салфетке" - бот для канала и чата. В связи с большим количеством спамеров, приходящих в чат и
спамящих своим "очень интересным предложением", возникла необходимость в защите - введением проверки новых пользователей
чата через "капчу", при правильном ответе на которую пользователь может продолжить общаться, в противном случае бот
исключает его из чата.

Способов решения задачи несколько, от чего она является идеальной для конкурса.

### Необходимо:
1. Реализовать "капчу" для нового участника чата.
2. "Капча" должна быть в виде изображения.
3. Для упрощения, достаточно реализовать задачу на сложение, результат которой будет проверять бот.
4. Дать пользователю три попытки на решение задачи.
5. Если пользователь три раза вводит неверный ответ - исключение из чата.
6. Все сообщения пользователя без верного ответа - удалять.
7. (Опционально) Добавить таймер в течении которого пользователь должен ответить верно (включая неверные ответы), если
   не было верного ответа или не было сообщений вовсе - исключение.

## Что было сделано?
Всех приветствую, уважаемые читатели!

Я, Александр Вязников и мне 14 лет. Я юный инженер-программист на Python по специализации back-end (в частности, разработка телеграмм-ботов). 
Я участник конкурса для начинающих программистов на Python от канала "Код на салфетке". Я проделал работу над вставкой модуля "капчи" для бота-администратора группы в канале "Код на салфетке" и защищаю свой вариант внедрения проверки на человека для бота. 

Работа заняла у меня в общей сложности 2 дня. 

Теперь, при входе в группу участника приветствует бот и отправляет картинку с элементарным сложением однозначных цифр. Пройти проверку - очень легко, справится даже первоклассник, но от ботов очень эффективная защита.

Я прочитал инструкцию, условия и все исходные данные. Я проанализировал весь код и логику работы бота. Подобрал вариант концепции модуля, подключил необходимые дополнительные библиотеки/фреймворки, включил логику работы базу данных и воспользовавшись своим опытом и знаниями работы с ООП, AIOgram и базами данных, завершил написанием кода для непосредственно модуля.   

Принцип таков:

- Пользователь заходит в группу. Ему дается строго 3 попытки и 3 минуты на прохождение капчи, при не выполнении условии - он удаляется из группы.
- Генерируется картинка для проверки.
- Картинка присылается в группу вместе с приветственным сообщением, ожидаемый(правильный) результат заносится в базу данных.
- Данные нового пользователя, кол-во попыток, дата начала проверки заносятся в базу данных в таблицу NewUser.
- Далее, анализируется каждое ID отправителя новых сообщений: из базы данных "вынимается" ID нового пользователя и сравнивается. Если оно совпадает с ID отправителя, то есть отправитель - новый пользователь, а значит идет второй этап проверки: проверка содержания самого сообщения. Оно сравнивается с ожидаемым результатом из базы данных. Если результат правильный - пользователю открывается полноценный доступ и таблица в БД очищается. Иначе, попытка сгорает (в базе данных значение также меняется).


Я использовал язык программирования Python и фреймворк AIOgram 3.8.0 для написания основных моментов. А также дополнительную библиотеку Pillow - для работы и создания самой картинки "капчи",
в качестве базы данных использовал связку SQLalchemy и AIOsqlite.


Всем оставльным участникам, коллегам желаю удачи, здоровая конкуренция и интересные, новые предложения с идеями - залог успеха!

## Как участвовать?
1. Необходимо сделать fork (именно fork, а не clone!) проекта. 
2. Написать функционал антиспама в отдельной ветке.
3. Убедиться, что всё работает.
4. Сделать push в свой репозиторий и из него pull request в наш.
5. Ждать начала голосования и участвовать в обсуждении своего и решений других участников.

## Используемые библиотеки
- aiogram 3
- pydantic-settings
- requests

## Запуск
1. Создать и активировать виртуальное окружение:
   ```bash
   python -m venv .venv

   # для Windows
   venv\Scripts\activate.ps1
   # или 
   venv\Scripts\activate.bat

   # для *NIX-систем
   source venv/bin/activate
   ```
2. Установить зависимости:
   ```bash
   pip install -r requirements.txt
   ```
3. Переименовать `.env.example` в `.env` и вписать соответствующие данные:
   ```
   TOKEN=ваш_токен_бота
   ADMIN_ID=id_администратора
   GROUP_ID=id_группы
   WEATHER_KEY=токен_погоды  # не обязателен для конкурса
   AUDIO_KEY_ID=id_распознавания_голоса  # не обязателен для конкурса
   AUDIO_KEY_SECRET=токен_распознавания_голоса  # не обязателен для конкурса
   ```
4. Запустить бота:
   ```bash
   python main.py
   ```
   
## Автор
Иван Ашихмин  
Telegram-канал "[Код на салфетке](https://t.me/press_any_button)"
